{% extends 'components/base.html' %}
{% load utils %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
    <h1 class="page-title fw-semibold fs-18 mb-0">Editar/Actualizar Presupuesto</h1>
    </div>
  </div>

  <div class="row">
    <!-- Formulario Principal -->
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-header">
          <div class="card-title">Información del Presupuesto</div>
        </div>
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {{ form.non_field_errors }}
              </div>
            {% endif %}
            <div class="row g-3">
              <!-- Título y Departamento -->
              <div class="col-md-3">
                <label class="form-label">{{ form.title.label }}</label>
                {{ form.title }}
                {% if form.title.errors %}
                  <div class="text-danger small">{{ form.title.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label">{{ form.department.label }}</label>
                {{form.department}}
                {% if form.department.errors %}
                  <div class="text-danger small">{{ form.department.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label">{{ form.type.label }}</label>
                {{form.type}}
                {% if form.type.errors %}
                  <div class="text-danger small">{{ form.type.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label">{{ form.status.label }}</label>
                {{form.status}}
                {% if form.status.errors %}
                  <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
              </div>
              <!-- Período -->
              <div class="col-xs-12 col-md-5 col-lg-5 col-xl-4">
                <label class="form-label">{{ form.due_date.label }}</label>
                {{ form.due_date }}
                {% if form.due_date.errors %}
                  <div class="text-danger small">{{ form.due_date.errors}}</div>
                {% endif %}
              </div>

              <!-- Montos -->
              <div class="col-xs-12 col-md-5 col-lg-5 col-xl-4">
                <label class="form-label">{{ form.total_mount.label }}</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.total_mount }}
                  {% if form.total_mount.errors %}
                    <div class="text-danger small">{{ form.total_mount.errors}}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-xs-12 col-md-2 col-lg-2 col-xl-4">
                <label class="form-label">{{ form.currency.label }}</label>
                {{form.currency}}
                {% if form.currency.errors %}
                    <div class="text-danger small">{{ form.currency.errors}}</div>
                {% endif %}
              </div>

              <!-- Descripción -->
              <div class="col-12">
                <label class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors%}
                  <div class="text-danger small">{{ form.description.errors}}</div>
                {% endif %}
              </div>

              <!-- Subir Archivo -->
              <div class="col-12">
                <label class="form-label fw-semibold mb-3 fs-5 d-block text-center">
                  Subir Nuevo Archivo
                </label>
                <div class="input-group mb-4">
                  <span class="input-group-text bg-gradient text-white" style="background-color: #5b4bff;">
                    <i class="ri-upload-2-line"></i>
                  </span>
                  {{ file_form.file }}
                </div>
              </div>

              <!-- Acciones del Form Principal -->
              <div class="col-12">
                <div class="card custom-card">
                  <div class="card-body">
                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="ri-save-line me-1"></i>Guardar Presupuesto
                      </button>
                      <a href="{% url 'app:detail_budget' budget.identifier %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>Cancelar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Lista de Archivos (Fuera del form principal) -->
    <div class="col-12 mt-3">
      <div class="card custom-card">
        <div class="card-header">
          <div class="card-title">Archivos Adjuntos</div>
        </div>
        <div class="card-body">
          {% if files %}
            <div class="table-responsive">
              <table class="table align-middle table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="text-start">Archivo</th>
                    <th scope="col" class="text-end">Ver</th>
                    <th scope="col" class="text-end">Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                  {% for file in files %}
                    <tr>
                      <td class="text-start">
                        <i class="ri-attachment-2 text-primary me-2 fs-5"></i>
                        {{ file.file|basename }}
                      </td>
                      <td class="text-end text-muted small">
                        <a href="{{ file.file.url }}" target="_blank" class="text-decoration-none text-dark fw-medium">
                          <i class="ri-eye-line"></i>
                        </a>
                      </td>
                      <td class="text-end">
                        <form method="POST" action="{% url 'app:delete_file_budget' file.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="delete_file" value="{{ file.id }}">
                          <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('¿Eliminar Archivo?')">
                            <i class="ri-delete-bin-line"></i>
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-light text-center text-muted mb-0 py-3" role="alert">
              <i class="ri-information-line me-2"></i>No hay archivos adjuntos.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
        </div>
      </div>
    </div>

    <!-- Panel Lateral -->
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const totalMountInput = document.querySelector('input[name="total_mount"]');

    if(totalMountInput){

      if(totalMountInput.value){
        totalMountInput.value = formatNumber(totalMountInput.value);
      }

      totalMountInput.addEventListener('input', (e) =>{
        let value = e.target.value;

        let unformatted = value.replace(/\D/g, '');

        if(unformatted){
          e.target.value = formatNumber(unformatted)
        } else{
          e.target.value = '';
        }
      });

      totalMountInput.closest('form').addEventListener('submit', () => {
        totalMountInput.value = totalMountInput.value.replace(/\./g, '');
      });
    }
});

function formatNumber(value){
    value = value.replace(/\./g, '');

    return value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}
</script>
{% endblock scripts %}